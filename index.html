<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iasmaintor - The Smarter Way to Prepare for UPSC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .fade-in-up {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-up.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .glowing-button {
            box-shadow: 0 0 5px #3b82f6, 0 0 10px #3b82f6, 0 0 15px #3b82f6;
        }
        .gradient-text {
            background: linear-gradient(to right, #2563eb, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-20px);
        }
        .modal.active .modal-content {
            transform: translateY(0);
        }
        [data-step] { display: none; }
        [data-step].active { display: block; }

        /* Custom styles for Quizzie form */
        .quiz-step-group {
            display: none;
        }
        .quiz-step-group.active {
            display: block;
        }
        
        /* Animation for loading dots */
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.2; }
        }
        .pulsing-dots span {
            animation: pulse 1.4s infinite;
        }
        .pulsing-dots span:nth-child(1) { animation-delay: 0s; }
        .pulsing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .pulsing-dots span:nth-child(3) { animation-delay: 0.4s; }

        /* Quiz navigation */
        .quiz-question {
            display: none;
        }
        .quiz-question.active {
            display: block;
        }
        .option-correct {
            background-color: #dcfce7 !important; /* green-100 */
            border-color: #22c55e !important; /* green-500 */
        }
        .option-incorrect {
            background-color: #fee2e2 !important; /* red-100 */
            border-color: #ef4444 !important; /* red-500 */
        }

        #quizzie-content {
            min-height: 450px;
        }

        /* Logo Animation */
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .ai-gradient {
            background: linear-gradient(-45deg, #3b82f6, #2563eb, #1d4ed8, #2563eb);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-animation 4s ease infinite;
        }
        .logo-container {
             transition: transform 0.3s ease-in-out;
        }
        .logo-container:hover {
            transform: scale(1.05);
        }
        /* Custom radio button cards */
        .radio-card-group input[type="radio"] {
            display: none;
        }
        .radio-card {
            border: 2px solid #e2e8f0; /* slate-200 */
            transition: all 0.2s ease-in-out;
        }
        .radio-card-group input[type="radio"]:checked + .radio-card {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
            box-shadow: 0 0 0 2px #3b82f6;
        }
    </style>
</head>
<body class="text-slate-800">

    <header id="header" class="bg-slate-50/80 backdrop-blur-lg fixed top-0 left-0 right-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="logo-container text-2xl font-bold text-slate-900">iasm<span class="ai-gradient">AI</span>ntor</a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="#features" class="text-slate-600 hover:text-blue-600 transition-colors">Features</a>
                <a href="#how-it-works" class="text-slate-600 hover:text-blue-600 transition-colors">How It Works</a>
                <a href="#testimonials" class="text-slate-600 hover:text-blue-600 transition-colors">Testimonials</a>
            </nav>
            <div class="flex items-center space-x-4">
                 <!-- Auth state is managed by JS by toggling 'hidden' -->
                <div id="auth-links" class="flex items-center space-x-4">
                    <a href="#" id="login-btn" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-transform hover:scale-105 shadow-md flex items-center justify-center">
                        <i class="fas fa-right-to-bracket mr-2"></i>Log In
                    </a>
                </div>
                <div id="user-dashboard-link" class="hidden items-center space-x-4">
                    <a href="#dashboard" class="font-semibold text-blue-600 hover:text-blue-700 transition-colors">My Dashboard</a>
                    <button id="logout-btn" class="text-slate-500 hover:text-red-500 transition-colors" title="Logout">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
            </div>
            <button id="mobile-menu-button" class="md:hidden text-slate-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
        <!-- Refactored Mobile Menu: Static content, visibility controlled by JS -->
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4 space-y-2">
            <a href="#features" class="block py-2 text-slate-600 hover:text-blue-600">Features</a>
            <a href="#how-it-works" class="block py-2 text-slate-600 hover:text-blue-600">How It Works</a>
            <a href="#testimonials" class="block py-2 text-slate-600 hover:text-blue-600">Testimonials</a>
            <a id="mobile-dashboard-link" href="#dashboard" class="hidden py-2 text-blue-600 font-semibold">My Dashboard</a>
            <hr/>
            <div id="mobile-auth-links">
                <a href="#" id="mobile-login-btn" class="block bg-blue-600 text-white text-center px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center">
                   <i class="fas fa-right-to-bracket mr-2"></i>Log In
                </a>
            </div>
            <div id="mobile-user-actions" class="hidden">
                 <button id="mobile-logout-btn" class="w-full mt-2 bg-red-500 text-white text-center px-5 py-2 rounded-lg font-semibold">Logout</button>
            </div>
        </div>
    </header>

    <main>
        <section class="pt-32 pb-20 bg-slate-100">
            <div class="container mx-auto px-6">
                <div class="grid md:grid-cols-2 gap-12 items-center">
                    <div class="text-center md:text-left">
                        <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 leading-tight mb-4">
                            Prepare <span class="gradient-text">Smarter</span>, Not Harder for UPSC
                        </h1>
                        <p class="text-lg text-slate-600 mb-8 max-w-xl mx-auto md:mx-0">
                            Your personalized AI mentor for cracking the Civil Services Exam. Get dynamic study plans, Mains answer feedback, and integrated resourcesâ€”all in one place.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start">
                            <a href="#" id="start-trial-btn" class="bg-blue-600 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-transform hover:scale-105 shadow-lg glowing-button">Start Your 7-Day Free Trial</a>
                        </div>
                    </div>
                    <div class="flex justify-center items-center p-4">
                        <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" class="w-full max-w-lg mx-auto">
                            <defs>
                                <linearGradient id="aspirantGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" stop-color="#475569"/>
                                    <stop offset="100%" stop-color="#1e293b"/>
                                </linearGradient>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="3.5" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <rect x="100" y="250" width="200" height="20" rx="2" fill="#94a3b8"/>
                            <rect x="105" y="230" width="190" height="20" rx="2" fill="#64748b"/>
                            <rect x="100" y="210" width="200" height="20" rx="2" fill="#94a3b8"/>
                            <rect x="110" y="190" width="180" height="20" rx="2" fill="#64748b"/>
                            <rect x="105" y="170" width="190" height="20" rx="2" fill="#94a3b8"/>
                            <path d="M200 165 C 200 145, 190 140, 180 130 A 15 15 0 1 1 220 130 C 210 140, 200 145, 200 165 Z" fill="url(#aspirantGradient)" transform="translate(0, -55)">
                                <animateTransform attributeName="transform" type="translate" values="0 -55; 0 -57; 0 -55" dur="3s" repeatCount="indefinite" />
                            </path>
                            <path d="M350 50 L355.878 67.639 L374.264 67.639 L359.193 78.881 L365.071 96.52 L350 85.278 L334.929 96.52 L340.807 78.881 L325.736 67.639 L344.122 67.639 Z" fill="#3b82f6" filter="url(#glow)">
                                <animate attributeName="opacity" values="1;0.7;1" dur="2s" repeatCount="indefinite" />
                            </path>
                            <circle cx="80" cy="220" r="10" fill="#cbd5e1" />
                            <rect x="70" y="230" width="20" height="30" rx="5" fill="#cbd5e1" />
                            <rect x="50" y="260" width="60" height="10" rx="2" fill="#e2e8f0" />
                            <circle cx="320" cy="230" r="8" fill="#cbd5e1" />
                            <rect x="312" y="238" width="16" height="25" rx="4" fill="#cbd5e1" />
                            <rect x="295" y="263" width="50" height="7" rx="2" fill="#e2e8f0" />
                        </svg>
                    </div>
                </div>
            </div>
        </section>

        <section id="features" class="py-20">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">The Ultimate Toolkit for Success in UPSC CSE</h2>
                <p class="text-slate-600 max-w-3xl mx-auto mb-12">Stop juggling countless resources. We bring everything you need into one intelligent platform, designed to optimize your preparation.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div id="quizzie-feature-card" class="feature-card bg-white p-8 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-2 transition-all duration-300 fade-in-up cursor-pointer">
                         <div class="bg-rose-100 text-rose-600 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 1.98-1.789 3.63-3.772 4.1-1.37.31-2.73.22-4.008-.25M8.228 9c-1.18.23-2.33.8-3.228 1.65a6 6 0 000 8.7L5 21M8.228 9l-2.5 2.5M15.772 15l2.5-2.5" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-900 mb-2">Quizzie - AI Quiz Module</h3>
                        <p class="text-slate-500">Generate UPSC-style quizzes based on subject, difficulty, and question type.</p>
                    </div>
                    <a href="https://maintor.vercel.app/" target="_blank" rel="noopener noreferrer" class="feature-card bg-white p-8 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-2 transition-all duration-300 fade-in-up" style="transition-delay: 150ms;">
                         <div class="bg-green-100 text-green-600 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-900 mb-2">Mains Answer Evaluation</h3>
                        <p class="text-slate-500">Get instant, data-driven feedback on your answer structure, content, and relevance.</p>
                    </a>
                    <div id="current-affairs-card" class="feature-card bg-white p-8 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-2 transition-all duration-300 fade-in-up cursor-pointer" style="transition-delay: 300ms;">
                         <div class="bg-indigo-100 text-indigo-600 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-6">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6" /></svg>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-900 mb-2">Integrated Current Affairs</h3>
                        <p class="text-slate-500">Daily news linked directly to syllabus topics, with notes and revision quizzes.</p>
                    </div>
                    <div id="planner-feature-card" class="feature-card bg-white p-8 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-2 transition-all duration-300 fade-in-up cursor-pointer" style="transition-delay: 450ms;">
                        <div class="bg-blue-100 text-blue-600 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3M5.636 5.636l-1.414-1.414M19.778 5.636l-1.414 1.414M18.364 18.364l1.414 1.414M4.222 18.364l1.414-1.414M12 12a3 3 0 100-6 3 3 0 000 6z" /></svg>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-900 mb-2">AI-Powered Study Plan</h3>
                        <p class="text-slate-500">A dynamic schedule that adapts to your progress, syllabus weightage, and time available.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="dashboard" class="hidden py-20 bg-slate-50">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-8 text-center">My Dashboard</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div id="saved-plans-container" class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-semibold mb-4">Your Saved Study Plans</h3>
                        <div id="plans-list" class="space-y-6"></div>
                    </div>
                    <div id="saved-quizzes-container" class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-semibold mb-4">Your Saved Quizzes</h3>
                        <div id="quizzes-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="how-it-works" class="py-20 bg-slate-100">
            <div class="container mx-auto px-6">
                <div class="text-center mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">Your Path to Success in 3 Simple Steps</h2>
                    <p class="text-slate-600 max-w-2xl mx-auto">We've simplified the journey. Focus on what matters most: learning and improving.</p>
                </div>
                <div class="relative">
                    <div class="hidden md:block absolute top-1/2 left-0 w-full h-0.5 bg-blue-200 -translate-y-1/2"></div>
                    <div class="grid md:grid-cols-3 gap-16 relative">
                        <div class="text-center fade-in-up">
                             <div class="relative inline-block">
                                <div class="bg-white h-24 w-24 rounded-full flex items-center justify-center text-blue-600 text-3xl font-bold shadow-lg border-4 border-blue-200">1</div>
                             </div>
                             <h3 class="text-xl font-semibold mt-6 mb-2">Generate Your AI Plan</h3>
                             <p class="text-slate-500">Answer a few questions and get a personalized study plan tailored to your needs and schedule.</p>
                        </div>
                        <div class="text-center fade-in-up" style="transition-delay: 200ms;">
                             <div class="relative inline-block">
                                <div class="bg-white h-24 w-24 rounded-full flex items-center justify-center text-blue-600 text-3xl font-bold shadow-lg border-4 border-blue-200">2</div>
                             </div>
                             <h3 class="text-xl font-semibold mt-6 mb-2">Follow The Daily Schedule</h3>
                             <p class="text-slate-500">Execute your daily tasksâ€”from reading topics and revising, to practicing questions and writing answers.</p>
                        </div>
                        <div class="text-center fade-in-up" style="transition-delay: 400ms;">
                             <div class="relative inline-block">
                                <div class="bg-white h-24 w-24 rounded-full flex items-center justify-center text-blue-600 text-3xl font-bold shadow-lg border-4 border-blue-200">3</div>
                             </div>
                             <h3 class="text-xl font-semibold mt-6 mb-2">Save, Track & Improve</h3>
                             <p class="text-slate-500">Save your plan to your dashboard. Monitor your progress and conquer your weaknesses.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="testimonials" class="py-20">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">What Our Aspirants Say</h2>
                    <p class="text-slate-600 max-w-2xl mx-auto">Success stories from those who chose the smarter way.</p>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white rounded-xl shadow-lg p-8 fade-in-up">
                        <p class="text-slate-600 mb-6">"iasmaintor's study planner is a game-changer. It removed all the guesswork and helped me cover the syllabus in a structured manner. For the first time, I feel in control of my preparation."</p>
                        <div class="flex items-center">
                            <img src="https://placehold.co/48x48/e0e7ff/3730a3?text=PS" alt="Priya Sharma" class="w-12 h-12 rounded-full mr-4" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=User';">
                            <div>
                                <h4 class="font-semibold text-slate-900">Priya Sharma</h4>
                                <p class="text-slate-500 text-sm">UPSC Aspirant</p>
                            </div>
                        </div>
                    </div>
                     <div class="bg-white rounded-xl shadow-lg p-8 fade-in-up" style="transition-delay: 200ms;">
                        <p class="text-slate-600 mb-6">"The instant feedback on mains answers is incredible. I've seen a massive improvement in my writing style and structure. The AI points out flaws I never would have noticed on my own."</p>
                        <div class="flex items-center">
                             <img src="https://placehold.co/48x48/d1fae5/047857?text=RP" alt="Rajdeep Pandey" class="w-12 h-12 rounded-full mr-4" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=User';">
                            <div>
                                <h4 class="font-semibold text-slate-900">Rajdeep Pandey</h4>
                                <p class="text-slate-500 text-sm">UPSC Aspirant</p>
                            </div>
                        </div>
                    </div>
                     <div class="bg-white rounded-xl shadow-lg p-8 fade-in-up" style="transition-delay: 400ms;">
                        <p class="text-slate-600 mb-6">"Finally, a platform that connects current affairs to the static syllabus seamlessly. This has saved me hours of work every single day. Highly recommended!"</p>
                        <div class="flex items-center">
                             <img src="https://placehold.co/48x48/fce7f3/831843?text=AV" alt="Anjali Verma" class="w-12 h-12 rounded-full mr-4" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=User';">
                            <div>
                                <h4 class="font-semibold text-slate-900">Anjali Verma</h4>
                                <p class="text-slate-500 text-sm">UPSC Aspirant</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-slate-800 text-white">
            <div class="container mx-auto px-6 py-20 text-center">
                <h2 class="text-3xl md:text-4xl font-bold mb-4">Ready to Transform Your UPSC Preparation?</h2>
                <p class="text-slate-300 max-w-2xl mx-auto mb-8">Join thousands of aspirants who are preparing smarter. Your journey to LBSNAA starts here.</p>
                <a href="#" id="final-cta-btn" class="bg-white text-blue-600 px-8 py-4 rounded-lg font-semibold text-lg hover:bg-slate-100 transition-transform hover:scale-105 shadow-lg">Start Your Free Trial Now</a>
            </div>
        </section>
    </main>
    
    <footer class="bg-slate-900 text-slate-400">
        <div class="container mx-auto px-6 py-12">
            <div class="grid md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold text-white mb-4">iasmaintor</h3>
                    <p class="text-sm">The Smarter Way to Prepare for UPSC.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-4">Company</h4>
                    <ul>
                        <li class="mb-2"><a href="#" class="hover:text-white">About Us</a></li>
                        <li class="mb-2"><a href="#" class="hover:text-white">Blog</a></li>
                        <li class="mb-2"><a href="#" class="hover:text-white">Contact</a></li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-white mb-4">Resources</h4>
                    <ul>
                        <li class="mb-2"><a href="#" class="hover:text-white">FAQs</a></li>
                        <li class="mb-2"><a href="#" class="hover:text-white">Terms of Service</a></li>
                        <li class="mb-2"><a href="#" class="hover:text-white">Privacy Policy</a></li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-semibold text-white mb-4">Follow Us</h4>
                    <div class="flex space-x-4">
                        <a href="#" class="hover:text-white">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd" /></svg>
                        </a>
                        <a href="#" class="hover:text-white">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.71v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84" /></svg>
                        </a>
                    </div>
                </div>
            </div>
            <div class="mt-12 border-t border-slate-700 pt-8 text-center text-sm">
                <p>&copy; <span id="copyright-year">2025</span> iasmaintor. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md modal-content p-8">
            <div class="flex justify-end">
                 <button id="close-auth-modal" class="text-slate-400 hover:text-slate-800 text-3xl leading-none">&times;</button>
            </div>
            
            <div id="auth-error" class="bg-red-100 text-red-700 p-3 rounded-md mb-4 hidden"></div>

            <!-- Login View -->
            <div id="login-view">
                <h2 class="text-3xl font-bold text-center text-slate-800 mb-2">Welcome Back</h2>
                <p class="text-center text-slate-500 mb-8">Please enter your details to log in.</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-slate-700 text-sm font-semibold mb-2">Email Address</label>
                        <input type="email" id="login-email" placeholder="e.g., user@example.com" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                    </div>
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                             <label for="login-password" class="block text-slate-700 text-sm font-semibold">Password</label>
                             <button type="button" id="forgot-password-btn" class="text-sm text-blue-600 hover:underline">Forgot Password?</button>
                        </div>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Log In</button>
                </form>
                <p class="text-center text-sm text-slate-600 mt-8">
                    Don't have an account? 
                    <button id="auth-switch-to-signup" class="font-semibold text-blue-600 hover:underline">Sign Up</button>
                </p>
            </div>

            <!-- Signup View -->
            <div id="signup-view" class="hidden">
                 <h2 class="text-3xl font-bold text-center text-slate-800 mb-2">Create Your Account</h2>
                 <p class="text-center text-slate-500 mb-8">Get started on your UPSC journey.</p>
                <form id="signup-form">
                     <div class="mb-4">
                        <label for="signup-email" class="block text-slate-700 text-sm font-semibold mb-2">Email Address</label>
                        <input type="email" id="signup-email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-slate-700 text-sm font-semibold mb-2">Password</label>
                        <input type="password" id="signup-password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required minlength="6">
                        <p class="text-xs text-slate-500 mt-1">Minimum 6 characters.</p>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Create Account</button>
                </form>
                <p class="text-center text-sm text-slate-600 mt-8">
                    Already have an account?
                    <button id="auth-switch-to-login" class="font-semibold text-blue-600 hover:underline">Log In</button>
                </p>
            </div>

            <!-- Forgot Password View -->
            <div id="forgot-password-view" class="hidden">
                <h2 class="text-3xl font-bold text-center text-slate-800 mb-2">Reset Password</h2>
                <p class="text-center text-slate-500 mb-8">Enter your email to receive a password reset link.</p>
                <form id="forgot-password-form">
                    <div class="mb-4">
                        <label for="reset-email" class="block text-slate-700 text-sm font-semibold mb-2">Email Address</label>
                        <input type="email" id="reset-email" placeholder="e.g., user@example.com" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Send Reset Link</button>
                </form>
                <p class="text-center text-sm text-slate-600 mt-8">
                    Remembered your password? 
                    <button id="auth-switch-to-login-from-reset" class="font-semibold text-blue-600 hover:underline">Back to Log In</button>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Planner Modal -->
    <div id="planner-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl modal-content my-8">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-slate-800">Create Your Personalized Study Plan</h2>
                    <button id="close-planner-modal" class="text-slate-400 hover:text-slate-800 text-3xl">&times;</button>
                </div>
                <div id="planner-content">
                    <form id="planner-questionnaire">
                        <div data-step="1" class="active">
                            <h3 class="text-xl font-semibold mb-4 text-slate-700">Step 1: About You</h3>
                            <div class="mb-4">
                                <label class="block text-slate-700 font-semibold mb-2">What is your current preparation level?</label>
                                <div class="flex flex-col space-y-2">
                                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input type="radio" name="level" value="beginner" class="mr-3" required> Beginner (Just starting out)</label>
                                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input type="radio" name="level" value="intermediate" class="mr-3"> Intermediate (Covered syllabus once)</label>
                                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input type="radio" name="level" value="veteran" class="mr-3"> Veteran (Multiple attempts, focused on revision)</label>
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button type="button" data-next="2" class="next-step-btn bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">Next</button>
                            </div>
                        </div>

                        <div data-step="2">
                            <h3 class="text-xl font-semibold mb-4 text-slate-700">Step 2: Your Schedule</h3>
                             <div class="mb-4">
                                <label class="block text-slate-700 font-semibold mb-2">How are you preparing?</label>
                                <div class="flex flex-col space-y-2">
                                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input type="radio" name="commitment" value="full-time" class="mr-3" required> Full-time aspirant</label>
                                    <label class="flex items-center p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input type="radio" name="commitment" value="working" class="mr-3"> Working professional</label>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="hours" class="block text-slate-700 font-semibold mb-2">How many hours can you study daily?</label>
                                <input type="number" id="hours" name="hours" min="2" max="14" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                            </div>
                             <div class="flex justify-between">
                                <button type="button" data-prev="1" class="prev-step-btn bg-slate-200 text-slate-800 px-6 py-2 rounded-lg font-semibold">Back</button>
                                <button type="button" data-next="3" class="next-step-btn bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">Next</button>
                            </div>
                        </div>

                        <div data-step="3">
                            <h3 class="text-xl font-semibold mb-4 text-slate-700">Step 3: Your Subjects</h3>
                            <div class="mb-4">
                                <label for="optional" class="block text-slate-700 font-semibold mb-2">What is your Optional Subject? (e.g., PSIR, Sociology, History)</label>
                                <input type="text" id="optional" name="optional" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required placeholder="Public Administration">
                            </div>
                             <div class="flex justify-between">
                                <button type="button" data-prev="2" class="prev-step-btn bg-slate-200 text-slate-800 px-6 py-2 rounded-lg font-semibold">Back</button>
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold">Generate Plan</button>
                            </div>
                        </div>
                    </form>
                    <div id="plan-result" class="hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quizzie Modal -->
    <div id="quizzie-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl modal-content my-8 max-h-[90vh] flex flex-col">
            <div class="p-6 border-b sticky top-0 bg-white z-10">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-800">AI Quiz Module</h2>
                    <button id="close-quizzie-modal" class="text-slate-400 hover:text-slate-800 text-3xl">&times;</button>
                </div>
                <!-- Progress Bar -->
                <div id="quiz-progress-bar" class="w-full bg-slate-200 rounded-full h-2.5">
                    <div id="quiz-progress-indicator" class="bg-blue-600 h-2.5 rounded-full" style="width: 25%"></div>
                </div>
                <div id="quiz-progress-text" class="text-center text-sm text-slate-500 mt-1">Step 1 of 4</div>
            </div>
            <div id="quizzie-content" class="p-8 overflow-y-auto flex-grow">
                <form id="quizzie-form">
                    <!-- Step 1: Main Subject -->
                    <div data-step="1" class="active space-y-6">
                        <h3 class="text-xl font-semibold text-slate-700">Choose your Subject</h3>
                        <div>
                            <select id="quiz-main-subject" name="main_subject" class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-white text-lg" required>
                                <option value="">-- Select a Subject --</option>
                                <option value="gs">General Studies (Prelims)</option>
                                <option value="csat">CSAT (Prelims)</option>
                            </select>
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="button" data-next="2" class="next-step-btn bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold text-base hover:bg-blue-700 transition-colors">Next</button>
                        </div>
                    </div>

                    <!-- Step 2: Test Type & Sectional Details -->
                    <div data-step="2" class="space-y-6">
                        <h3 class="text-xl font-semibold text-slate-700">Define your Test</h3>
                        
                        <div class="radio-card-group">
                            <label class="block text-slate-700 font-semibold mb-2">Test Type</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <label>
                                    <input type="radio" name="test_type" value="sectional" class="mr-3" required>
                                    <div class="radio-card p-4 rounded-lg cursor-pointer text-center">
                                        <div class="font-bold text-lg">Sectional Test</div>
                                        <div class="text-sm text-slate-500">Focus on a specific subject</div>
                                    </div>
                                </label>
                                <label>
                                    <input type="radio" name="test_type" value="flt" class="mr-3"> 
                                    <div class="radio-card p-4 rounded-lg cursor-pointer text-center">
                                        <div class="font-bold text-lg">Full Length Test</div>
                                        <div class="text-sm text-slate-500">Simulate the real exam</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Sectional Subject for GS -->
                        <div id="gs-sectional-group" class="quiz-step-group">
                            <label for="gs-subject" class="block text-slate-700 font-semibold mb-2">Sectional Subject</label>
                            <select id="gs-subject" name="gs_subject" class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-white text-base">
                                <option value="history">History</option>
                                <option value="geography">Geography</option>
                                <option value="polity">Polity</option>
                                <option value="economy">Economy</option>
                                <option value="environment">Environment</option>
                                <option value="science-tech">Science & Tech</option>
                            </select>
                        </div>
                        
                        <!-- Sectional Subject for CSAT -->
                        <div id="csat-sectional-group" class="quiz-step-group">
                            <label for="csat-subject" class="block text-slate-700 font-semibold mb-2">Sectional Subject</label>
                            <select id="csat-subject" name="csat_subject" class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-white text-base">
                                <option value="quant">Quant</option>
                                <option value="reasoning">Reasoning</option>
                                <option value="comprehension">Comprehension</option>
                            </select>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button type="button" data-prev="1" class="prev-step-btn bg-slate-200 text-slate-800 px-8 py-3 rounded-lg font-semibold text-base hover:bg-slate-300 transition-colors">Back</button>
                            <button type="button" data-next="3" class="next-step-btn bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold text-base hover:bg-blue-700 transition-colors">Next</button>
                        </div>
                    </div>

                    <!-- Step 3: Questions & Type -->
                    <div data-step="3" class="space-y-6">
                         <h3 class="text-xl font-semibold text-slate-700">Customize Questions</h3>

                         <!-- Number of Questions (for Sectional) -->
                        <div id="num-questions-group" class="quiz-step-group">
                            <label for="num-questions" class="block text-slate-700 font-semibold mb-2">Number of Questions</label>
                            <select id="num-questions" name="num_questions" class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-white text-base">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>

                         <!-- Question Type (for GS Sectional) -->
                        <div id="question-type-group" class="quiz-step-group">
                            <label class="block text-slate-700 font-semibold mb-2">Nature of Questions</label>
                            <select name="question_type" class="w-full px-4 py-3 border border-slate-300 rounded-lg bg-white text-base">
                                <option value="static">Static</option>
                                <option value="current">Current Affairs</option>
                                <option value="blend">A Blend of Static & Current</option>
                            </select>
                        </div>

                        <div class="flex justify-between pt-4">
                            <button type="button" data-prev="2" class="prev-step-btn bg-slate-200 text-slate-800 px-8 py-3 rounded-lg font-semibold text-base hover:bg-slate-300 transition-colors">Back</button>
                            <button type="button" data-next="4" class="next-step-btn bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold text-base hover:bg-blue-700 transition-colors">Next</button>
                        </div>
                    </div>
                    
                    <!-- Step 4: Difficulty -->
                    <div data-step="4" class="space-y-6">
                        <h3 class="text-xl font-semibold text-slate-700">Difficulty Level</h3>
                        <div class="radio-card-group">
                           <label class="block text-slate-700 font-semibold mb-2">Choose Difficulty</label>
                           <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                               <label>
                                   <input type="radio" name="difficulty" value="basic" checked required>
                                   <div class="radio-card p-4 rounded-lg cursor-pointer text-center">
                                        <div class="font-bold text-lg">Basic</div>
                                        <div class="text-sm text-slate-500">Fundamental concepts</div>
                                   </div>
                               </label>
                               <label>
                                   <input type="radio" name="difficulty" value="advanced">
                                   <div class="radio-card p-4 rounded-lg cursor-pointer text-center">
                                        <div class="font-bold text-lg">Advanced</div>
                                        <div class="text-sm text-slate-500">Tricky & analytical</div>
                                   </div>
                               </label>
                           </div>
                        </div>
                        <div class="flex justify-between pt-4">
                            <button type="button" data-prev="3" class="prev-step-btn bg-slate-200 text-slate-800 px-8 py-3 rounded-lg font-semibold text-base hover:bg-slate-300 transition-colors">Back</button>
                            <button type="submit" class="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold text-base hover:bg-green-700 transition-colors">Generate Quiz</button>
                        </div>
                    </div>

                </form>
                <div id="quiz-result" class="hidden"></div>
                <div id="quiz-active-view" class="hidden"></div>
            </div>
            <!-- Static Quiz Footer -->
            <div id="quiz-footer" class="p-6 border-t bg-slate-50 rounded-b-lg hidden">
                <div class="flex justify-between">
                    <button id="prev-q-btn" class="bg-slate-200 text-slate-800 px-6 py-2 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Previous</button>
                    <button id="next-q-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Next</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none"></div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', async function() {
            // --- Firebase Initialization ---
            let app, db, auth;
            let firebaseEnabled = false;
            let firebaseAuth; // To store auth functions
            
            const firebaseConfig = {
              apiKey: "AIzaSyBwUfBVI5ApoasTN4nG8H-PA4F_cRMn30s",
              authDomain: "iasmaintor.firebaseapp.com",
              projectId: "iasmaintor",
              storageBucket: "iasmaintor.appspot.com",
              messagingSenderId: "1088929315393",
              appId: "1:1088929315393:web:5d2b9a0b1a2a4b8c7d6c7e"
            };

            try {
                const [appModule, authModule, firestoreModule] = await Promise.all([
                    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"),
                    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"),
                    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js")
                ]);
                
                app = appModule.initializeApp(firebaseConfig);
                db = firestoreModule.getFirestore(app);
                auth = authModule.getAuth(app);
                firebaseAuth = authModule;
                appModule.setLogLevel('debug');
                firebaseEnabled = true;

                firebaseAuth.onAuthStateChanged(auth, (user) => {
                    currentUser = user; 
                    updateUIForAuthState(user);
                });
                console.log("Firebase initialized successfully.");
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to online services.", true);
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let currentUser = null;
            let generatedPlanHTML = '';
            let unsubscribePlans = null;
            let unsubscribeQuizzes = null;
            let quizQuestions = [];
            let userAnswers = [];
            let currentQuizResultHTML = '';
            let currentQuizParams = {};

            
            // --- UI Element Refs ---
            const DOMElements = {
                authLinks: document.getElementById('auth-links'),
                userDashboardLink: document.getElementById('user-dashboard-link'),
                dashboardSection: document.getElementById('dashboard'),
                mobileMenuButton: document.getElementById('mobile-menu-button'),
                mobileMenu: document.getElementById('mobile-menu'),
                mobileAuthLinks: document.getElementById('mobile-auth-links'),
                mobileUserActions: document.getElementById('mobile-user-actions'),
                mobileDashboardLink: document.getElementById('mobile-dashboard-link'),
                header: document.getElementById('header'),
                notification: document.getElementById('notification'),
                authModal: {
                    modal: document.getElementById('auth-modal'),
                    error: document.getElementById('auth-error'),
                    loginForm: document.getElementById('login-form'),
                    signupForm: document.getElementById('signup-form'),
                    forgotPasswordView: document.getElementById('forgot-password-view'),
                    forgotPasswordForm: document.getElementById('forgot-password-form'),
                },
                plannerModal: {
                    modal: document.getElementById('planner-modal'),
                    questionnaire: document.getElementById('planner-questionnaire'),
                    planResult: document.getElementById('plan-result'),
                },
                quizzieModal: {
                    modal: document.getElementById('quizzie-modal'),
                    form: document.getElementById('quizzie-form'),
                    result: document.getElementById('quiz-result'),
                    activeView: document.getElementById('quiz-active-view'),
                    gsSectionalGroup: document.getElementById('gs-sectional-group'),
                    csatSectionalGroup: document.getElementById('csat-sectional-group'),
                    numQuestionsGroup: document.getElementById('num-questions-group'),
                    questionTypeGroup: document.getElementById('question-type-group'),
                    progressBar: document.getElementById('quiz-progress-bar'),
                    progressIndicator: document.getElementById('quiz-progress-indicator'),
                    progressText: document.getElementById('quiz-progress-text'),
                },
                plansList: document.getElementById('plans-list'),
                quizzesList: document.getElementById('quizzes-list'),
                copyrightYear: document.getElementById('copyright-year'),
            };
            
            // --- Utility Functions ---
            const showNotification = (message, isError = false) => {
                DOMElements.notification.textContent = message;
                DOMElements.notification.classList.toggle('bg-red-600', isError);
                DOMElements.notification.classList.toggle('bg-slate-800', !isError);
                DOMElements.notification.classList.add('opacity-100');
                setTimeout(() => DOMElements.notification.classList.remove('opacity-100'), 3000);
            };

            const openModal = (modal) => modal.classList.remove('hidden');
            const closeModal = (modal) => modal.classList.add('hidden');
            const openAuthModal = (mode = 'login') => {
                const { modal, loginForm, signupForm, error, forgotPasswordView } = DOMElements.authModal;
                error.classList.add('hidden');
                loginForm.reset();
                signupForm.reset();
                forgotPasswordView.classList.add('hidden');
                document.getElementById('login-view').classList.toggle('hidden', mode !== 'login');
                document.getElementById('signup-view').classList.toggle('hidden', mode !== 'signup');
                openModal(modal);
            };

            // --- Core App Logic ---
            DOMElements.copyrightYear.textContent = new Date().getFullYear();

            const updateUIForAuthState = (user) => {
                const isLoggedIn = !!user;
                DOMElements.authLinks.classList.toggle('hidden', isLoggedIn);
                DOMElements.userDashboardLink.classList.toggle('hidden', !isLoggedIn);
                DOMElements.dashboardSection.classList.toggle('hidden', !isLoggedIn);
                DOMElements.mobileAuthLinks.classList.toggle('hidden', isLoggedIn);
                DOMElements.mobileUserActions.classList.toggle('hidden', !isLoggedIn);
                DOMElements.mobileDashboardLink.classList.toggle('hidden', !isLoggedIn);
                
                if (isLoggedIn) {
                    fetchAndDisplayPlans(user.uid);
                    fetchAndDisplayQuizzes(user.uid);
                } else {
                    if (unsubscribePlans) unsubscribePlans();
                    if (unsubscribeQuizzes) unsubscribeQuizzes();
                    DOMElements.plansList.innerHTML = `<p class="text-slate-500">Please log in to see your saved plans.</p>`;
                    DOMElements.quizzesList.innerHTML = `<p class="text-slate-500">Please log in to see your saved quizzes.</p>`;
                }
            };
            
            const generateAIStudyPlan = async (answers) => {
                 const { level, commitment, hours, optional } = answers;
                
                const systemPrompt = `You are an expert mentor for the Indian Civil Services (UPSC) examination. Your task is to generate a personalized, structured, and actionable 7-day study plan for an aspirant. The plan must be in the format of an HTML table. The table should have three columns: "Day", "Focus", and "Tasks". The "Tasks" column should contain an unordered list (\`<ul>\`).`;

                const userQuery = `Generate a 7-day study plan for a UPSC aspirant with the following profile:
- Preparation Level: ${level}
- Commitment: ${commitment}
- Daily Study Hours: ${hours}
- Optional Subject: ${optional}

The plan should be practical and cover a mix of General Studies subjects and the optional subject, including time for current affairs and revision. Create the output as a single HTML \`<table>\` with a \`<thead>\` and \`<tbody>\`. Do not include any other HTML tags like \`<html>\` or \`<body>\`.`;
                
                const apiKey = "AIzaSyAHB9BDQD7xOP1VDTavcqr30IEwlZkIM64";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    const htmlContent = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (htmlContent) {
                        return htmlContent;
                    }
                    throw new Error("Empty response from AI.");
                } catch (error) {
                    console.error("Error generating AI study plan:", error);
                    return "<p class='text-red-500'>Sorry, we couldn't generate a plan at this time. Please try again later.</p>";
                }
            };

            const savePlan = async () => {
                if (!currentUser) { showNotification('Please log in to save.', true); openAuthModal('signup'); return; }
                const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'studyPlans'), { planHTML: generatedPlanHTML, createdAt: serverTimestamp() });
                    showNotification('Plan saved successfully!');
                    closeModal(DOMElements.plannerModal.modal);
                } catch (error) { console.error("Error saving plan:", error); showNotification('Could not save plan.', true); }
            };
            
            const fetchAndDisplayPlans = async (userId) => {
                if (unsubscribePlans) unsubscribePlans();
                const { collection, query, orderBy, onSnapshot } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const q = query(collection(db, 'artifacts', appId, 'users', userId, 'studyPlans'), orderBy('createdAt', 'desc'));
                unsubscribePlans = onSnapshot(q, (snapshot) => {
                    DOMElements.plansList.innerHTML = snapshot.empty ? `<p class="text-slate-500">You haven't saved any plans yet.</p>` :
                        snapshot.docs.map(doc => {
                            const { createdAt, planHTML } = doc.data();
                            const date = createdAt?.toDate().toLocaleDateString() || 'Recently';
                            return `<div class="border-b last:border-b-0 pb-6"><p class="font-semibold text-slate-600 mb-4">Plan created on: ${date}</p>${planHTML.replace(/<div class="mt-8.*?<\/div>/s, '')}</div>`;
                        }).join('');
                }, (error) => {
                    console.error("Error fetching plans:", error);
                    DOMElements.plansList.innerHTML = `<p class="text-red-500">Could not fetch plans.</p>`;
                });
            };

            // --- Quizzie Logic ---
            const resetQuizzieModal = () => {
                const { form, result, activeView, modal } = DOMElements.quizzieModal;
                form.reset();
                form.classList.remove('hidden');
                result.classList.add('hidden');
                activeView.classList.add('hidden');
                document.getElementById('quiz-footer').classList.add('hidden');
                result.innerHTML = '';
                activeView.innerHTML = '';
                quizQuestions = [];
                userAnswers = [];
                currentQuizResultHTML = '';
                currentQuizParams = {};
                form.querySelectorAll('[data-step]').forEach((step, index) => {
                    step.classList.toggle('active', index === 0);
                });

                modal.querySelector('#quiz-progress-bar').parentElement.classList.remove('hidden');
                
                updateQuizzieForm();
                updateQuizProgressBar(1, 4);
            };

            const updateQuizzieForm = () => {
                const { gsSectionalGroup, csatSectionalGroup, numQuestionsGroup, questionTypeGroup, form } = DOMElements.quizzieModal;
                const formData = new FormData(form);
                const mainSubject = formData.get('main_subject');
                const testType = formData.get('test_type');
                gsSectionalGroup.style.display = 'none';
                csatSectionalGroup.style.display = 'none';
                numQuestionsGroup.style.display = 'none';
                questionTypeGroup.style.display = 'none';
                if (testType === 'sectional') {
                    numQuestionsGroup.style.display = 'block';
                    if (mainSubject === 'gs') {
                        gsSectionalGroup.style.display = 'block';
                        questionTypeGroup.style.display = 'block';
                    } else if (mainSubject === 'csat') {
                        csatSectionalGroup.style.display = 'block';
                    }
                }
            };

            const updateQuizProgressBar = (current, total) => {
                const { progressIndicator, progressText } = DOMElements.quizzieModal;
                const percentage = (current / total) * 100;
                progressIndicator.style.width = `${percentage}%`;
                progressText.textContent = `Step ${current} of ${total}`;
            };
            
            const generateQuizQuestions = async (params) => {
                try {
                    const { main_subject, test_type, gs_subject, csat_subject, num_questions, difficulty, question_type } = params;
                    const count = test_type === 'flt' ? 5 : parseInt(num_questions);

                    const systemPrompt = `You are an expert quiz generator for the Indian Civil Services (UPSC) examination. Your task is to create high-quality Multiple Choice Questions (MCQs) based on the user's request. The questions should be in the style and standard of the UPSC Prelims exam.
- If the user selects 'basic' difficulty, generate straightforward, knowledge-based questions that test fundamental concepts.
- If the user selects 'advanced' difficulty, generate tricky, application-based, or multi-statement questions (e.g., "How many of the above statements are correct?") that require deeper analysis and are designed to be challenging.
For each question, provide a question, four options in an array, the correct answer (which must be one of the provided options), and a detailed and thorough explanation that elaborates on why the correct answer is right and why the other options are incorrect. You must return the response in a valid JSON format according to the provided schema.`;

                    let userQuery = `Generate ${count} questions. Difficulty: ${difficulty}. `;
                    if (test_type === 'flt') {
                        userQuery += `This is a Full Length Test for ${main_subject === 'gs' ? 'General Studies' : 'CSAT'}. The questions should cover a mix of subjects relevant to this paper.`;
                    } else {
                        const subject = main_subject === 'gs' ? gs_subject : csat_subject;
                        userQuery += `This is a sectional test for the subject: ${subject}. `;
                        if (main_subject === 'gs') {
                            userQuery += `The nature of questions should be: ${question_type}.`;
                        }
                    }
                    
                    const apiKey = "AIzaSyAHB9BDQD7xOP1VDTavcqr30IEwlZkIM64"; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "questions": {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                "question": { "type": "STRING" },
                                                "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                                                "answer": { "type": "STRING" },
                                                "explanation": { "type": "STRING" }
                                            },
                                            required: ["question", "options", "answer", "explanation"]
                                        }
                                    }
                                }
                            }
                        }
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                     if (!response.ok) {
                        let errorMsg = `API request failed with status ${response.status}`;
                        if (response.status === 403) {
                            errorMsg = "API request failed: Forbidden (403). This may be an issue with API key configuration in the environment.";
                        }
                        console.error(errorMsg);
                        const errorBody = await response.text();
                        console.error("Error body:", errorBody);
                        throw new Error(errorMsg);
                    }

                    const result = await response.json();
                    console.log("Full API Response:", result);

                    if (!result.candidates || result.candidates.length === 0) {
                        const blockReason = result.promptFeedback?.blockReason;
                        const errorMessage = blockReason 
                            ? `No content generated by the AI due to a safety block: ${blockReason}`
                            : "No candidates returned from API.";
                        console.error(errorMessage);
                        throw new Error(errorMessage);
                    }
                    
                    const candidate = result.candidates[0];
                    const jsonText = candidate.content?.parts?.[0]?.text;

                    if (!jsonText) {
                        const finishReason = candidate.finishReason;
                        const errorMessage = `AI response was empty or malformed. Finish Reason: ${finishReason || 'Unknown'}`;
                        console.error(errorMessage);
                        console.error("Candidate details:", candidate);
                        throw new Error(errorMessage);
                    }

                    try {
                        const cleanedJsonText = jsonText.replace(/^```json\s*/, '').replace(/```$/, '').trim();
                        const parsedJson = JSON.parse(cleanedJsonText);
                        const questions = parsedJson.questions || [];
                        
                        if (questions.length === 0) {
                             console.warn("AI generated a valid JSON but with an empty questions array.");
                        }

                        if (questions.length > count) {
                            questions.length = count;
                        }
                        
                        const validQuestions = questions.filter(q => q && q.question && q.options && Array.isArray(q.options) && q.answer && q.explanation);
                        if (validQuestions.length !== questions.length) {
                            console.warn("Some generated questions were invalid and have been filtered out.");
                        }

                        return validQuestions.map(q => ({...q, subject: gs_subject || csat_subject, answerIndex: q.options.indexOf(q.answer)}));
                    } catch (parseError) {
                         console.error("Failed to parse JSON response from AI:", parseError);
                         console.error("Invalid JSON string received:", jsonText);
                         throw new Error("Failed to parse AI response.");
                    }
                } catch (error) {
                    console.error("Error in generateQuizQuestions:", error);
                    throw error;
                }
            };

            const generateAIFeedback = async (correctCount, incorrectCount, unansweredCount, totalQuestions, wrongQuestions) => {
                const systemPrompt = `You are an expert mentor for the UPSC Civil Services Exam. Your task is to provide a concise, insightful, and encouraging analysis of a student's quiz performance. Your analysis should be in a single paragraph.`;

                let userQuery = `A student has just completed a quiz. Here is their performance summary:
- Total Questions: ${totalQuestions}
- Correct Answers: ${correctCount}
- Incorrect Answers: ${incorrectCount}
- Unanswered: ${unansweredCount}

Here are the questions the student answered incorrectly, along with their correct answers and explanations:
${JSON.stringify(wrongQuestions, null, 2)}

Based on this data, provide a concise, insightful, and encouraging analysis of the student's performance. Your analysis should be in a single paragraph and do the following:
1. Start with an overall assessment (e.g., "Good attempt," "This indicates a need for more focus," etc.).
2. Identify potential patterns in the mistakes. Are they conceptual errors, factual mistakes, or related to a specific topic? Do not just list the topics.
3. Suggest specific, actionable areas for improvement. For example, 'It seems you're struggling with chronology in Ancient History. Revisiting a timeline chart could be helpful.' or 'The errors in Polity suggest a need to brush up on Fundamental Rights.'
4. Maintain a supportive and motivational tone.`;

                const apiKey = "AIzaSyAHB9BDQD7xOP1VDTavcqr30IEwlZkIM64";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const feedbackText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    return feedbackText || "Could not generate feedback at this time.";
                } catch(error) {
                    console.error("AI Feedback generation failed:", error);
                    return "Could not generate AI feedback at this time due to a network or API issue.";
                }
            };


            const displayQuiz = () => {
                const { activeView } = DOMElements.quizzieModal;
                const footer = document.getElementById('quiz-footer');
                const prevBtn = document.getElementById('prev-q-btn');
                const nextBtn = document.getElementById('next-q-btn');
                let currentQuestionIndex = 0;

                function updateFooterButtons() {
                    prevBtn.classList.toggle('invisible', currentQuestionIndex === 0);
                    nextBtn.textContent = currentQuestionIndex === quizQuestions.length - 1 ? 'Submit Quiz' : 'Next';
                }

                function renderQuestion() {
                    if (quizQuestions.length === 0) {
                        activeView.innerHTML = `<div class="p-4 text-center">No questions available for this combination. Please try again.</div> <div class="mt-6 flex justify-end"><button data-action="retake-quiz" class="bg-slate-200 text-slate-800 px-6 py-2 rounded-lg font-semibold">Start Over</button></div>`;
                        footer.classList.add('hidden');
                        return;
                    }
                    const q = quizQuestions[currentQuestionIndex];
                    let optionsHTML = q.options.map((opt, index) => `
                        <label>
                            <input type="radio" name="q${currentQuestionIndex}" value="${index}" class="hidden" ${userAnswers[currentQuestionIndex] == index ? 'checked' : ''}>
                            <div class="p-4 border-2 border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer radio-card">
                                <span class="text-slate-700">${opt}</span>
                            </div>
                        </label>
                    `).join('');

                    activeView.innerHTML = `
                        <div class="quiz-question active">
                            <div class="mb-4 text-sm text-slate-500 font-semibold">Question ${currentQuestionIndex + 1} of ${quizQuestions.length}</div>
                            <p class="mb-6 text-slate-800 text-lg whitespace-pre-wrap text-left">${q.question}</p>
                            <div class="space-y-3 radio-card-group">${optionsHTML}</div>
                        </div>
                    `;
                    updateFooterButtons();
                }

                function navigate(direction) {
                    if (direction === 'next' && currentQuestionIndex < quizQuestions.length - 1) {
                        currentQuestionIndex++;
                    } else if (direction === 'prev' && currentQuestionIndex > 0) {
                        currentQuestionIndex--;
                    } else if (direction === 'next' && currentQuestionIndex === quizQuestions.length - 1) {
                        calculateAndShowResults();
                        return;
                    }
                    renderQuestion();
                }

                activeView.onchange = (e) => {
                    if(e.target.type === 'radio') {
                       userAnswers[currentQuestionIndex] = parseInt(e.target.value);
                    }
                };

                footer.onclick = (e) => {
                    if (e.target.id === 'next-q-btn') navigate('next');
                    if (e.target.id === 'prev-q-btn') navigate('prev');
                };
                
                renderQuestion();
            };
            
            const calculateAndShowResults = async () => {
                const { activeView, modal } = DOMElements.quizzieModal;
                document.getElementById('quiz-footer').classList.add('hidden');
                modal.querySelector('#quiz-progress-bar').parentElement.classList.add('hidden');
                
                let score = 0;
                let correctCount = 0;
                let incorrectCount = 0;
                let unansweredCount = 0;
                const wrongQuestions = [];

                quizQuestions.forEach((q, index) => {
                    const userAnswerIndex = userAnswers[index];
                    if (userAnswerIndex === undefined) {
                        unansweredCount++;
                    } else if (userAnswerIndex === q.answerIndex) {
                        correctCount++;
                        score += 2;
                    } else {
                        incorrectCount++;
                        score -= 0.66;
                        wrongQuestions.push({
                            question: q.question,
                            yourAnswer: q.options[userAnswerIndex],
                            correctAnswer: q.answer,
                            explanation: q.explanation,
                            subject: q.subject || 'general'
                        });
                    }
                });
                
                let resultHTML = `
                    <div class="text-center">
                        <h3 class="text-3xl font-bold text-slate-800">Quiz Results</h3>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 my-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-sm text-blue-700 font-semibold">SCORE</div>
                            <div class="text-3xl font-bold text-blue-900">${score.toFixed(2)} / ${quizQuestions.length * 2}</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-sm text-green-700 font-semibold">CORRECT</div>
                            <div class="text-3xl font-bold text-green-900">${correctCount}</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-sm text-red-700 font-semibold">INCORRECT</div>
                            <div class="text-3xl font-bold text-red-900">${incorrectCount}</div>
                        </div>
                    </div>
                    <div id="ai-feedback-container" class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded-r-lg">
                        <h4 class="font-bold mb-1">AI-Powered Feedback & Analysis</h4>
                        <div id="ai-feedback-content">
                            <div class="font-semibold flex items-center">
                                <span>Analyzing your performance</span>
                                <span class="pulsing-dots ml-1"><span>.</span><span>.</span><span>.</span></span>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold mt-8 mb-4">Review Your Answers</h3>
                `;

                resultHTML += quizQuestions.map((q, index) => {
                    const userAnswerIndex = userAnswers[index];
                    const optionsReview = q.options.map((opt, optIndex) => {
                        let classes = 'p-3 border rounded-lg flex items-center text-left';
                        let icon = '';
                        if(optIndex === q.answerIndex) {
                            classes += ' option-correct';
                            icon = `<i class="fas fa-check-circle text-green-500 mr-3"></i>`;
                        } else if (userAnswerIndex === optIndex && userAnswerIndex !== q.answerIndex) {
                            classes += ' option-incorrect';
                            icon = `<i class="fas fa-times-circle text-red-500 mr-3"></i>`;
                        } else {
                            icon = `<i class="far fa-circle text-slate-300 mr-3"></i>`;
                        }
                        return `<div class="${classes}">${icon}<span>${opt}</span></div>`;
                    }).join('');

                    return `
                        <div class="mb-6 border-b pb-6">
                            <p class="font-semibold mb-3 text-slate-800">Q ${index + 1}: ${q.question}</p>
                            <div class="space-y-2">${optionsReview}</div>
                            <div class="mt-3 p-3 bg-slate-100 rounded-lg text-sm">
                                <p><strong>Explanation:</strong> ${q.explanation}</p>
                            </div>
                        </div>
                    `;
                }).join('');

                resultHTML += `<div class="mt-8 flex justify-between items-center"><button data-action="save-quiz" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold">Save Quiz Result</button><button data-action="retake-quiz" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">Take Another Quiz</button></div>`;

                activeView.innerHTML = resultHTML;
                currentQuizResultHTML = activeView.innerHTML; // Store for saving

                // Generate and display AI feedback
                const aiFeedbackContainer = activeView.querySelector('#ai-feedback-content');
                try {
                    const feedback = await generateAIFeedback(correctCount, incorrectCount, unansweredCount, quizQuestions.length, wrongQuestions);
                    aiFeedbackContainer.innerHTML = `<p>${feedback}</p>`;
                    currentQuizResultHTML = activeView.innerHTML; // Update with feedback
                } catch (error) {
                    console.error("Failed to get AI feedback:", error);
                    aiFeedbackContainer.innerHTML = `<p>Could not generate AI feedback at this time. Please review the explanations below.</p>`;
                }
            };

            const handleQuizSubmit = async (e) => {
                e.preventDefault();
                const { form, result, activeView, modal } = DOMElements.quizzieModal;
                modal.querySelector('#quiz-progress-bar').parentElement.classList.add('hidden');
                const formData = new FormData(form);
                currentQuizParams = Object.fromEntries(formData.entries());

                form.classList.add('hidden');
                result.classList.remove('hidden');
                result.innerHTML = `<div class="p-4 bg-blue-50 rounded-lg text-center"><div class="font-semibold flex items-center justify-center"><span>Generating Questions with AI</span><span class="pulsing-dots ml-1"><span>.</span><span>.</span><span>.</span></span></div></div>`;
                
                try {
                    quizQuestions = await generateQuizQuestions(currentQuizParams);
                    userAnswers = new Array(quizQuestions.length);
                    result.classList.add('hidden');
                    activeView.classList.remove('hidden');

                    if (quizQuestions.length > 0) {
                        document.getElementById('quiz-footer').classList.remove('hidden');
                        displayQuiz();
                    } else {
                        // This case handles when the AI returns a valid, but empty, list of questions.
                        activeView.innerHTML = `<div class="text-center p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                                    <h4 class="font-bold text-yellow-800">No Questions Generated</h4>
                                                    <p class="text-yellow-700 mt-2">The AI could not generate questions for this specific combination. Please try different options.</p>
                                                    <button data-action="retake-quiz" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">Start Over</button>
                                                </div>`;
                    }
                } catch (error) {
                    result.classList.add('hidden');
                    activeView.classList.remove('hidden');
                    activeView.innerHTML = `<div class="text-center p-4 bg-red-50 border border-red-200 rounded-lg">
                                                <h4 class="font-bold text-red-800">Quiz Generation Failed</h4>
                                                <p class="text-red-700 mt-2">${error.message}</p>
                                                <p class="text-sm text-slate-500 mt-4">This can happen due to network issues, invalid API configuration, or if the AI's safety filters are triggered. Please check the console for more details and try again.</p>
                                                <button data-action="retake-quiz" class="mt-6 bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">Start Over</button>
                                            </div>`;
                }
            };


            const saveQuizResult = async (button) => {
                if (!currentUser) { 
                    showNotification('Please log in to save.', true);
                    return; 
                }
                if (button.disabled) {
                    button.textContent = 'Already Saved!';
                    setTimeout(() => { button.textContent = 'Save Quiz Result' }, 2000);
                    return;
                }

                const { addDoc, collection, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'savedQuizzes'), {
                        quizHTML: currentQuizResultHTML,
                        params: currentQuizParams,
                        createdAt: serverTimestamp()
                    });
                    showNotification('Quiz result saved successfully!');
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                    button.textContent = 'Saved!';
                } catch (error) {
                    console.error("Error saving quiz:", error);
                    showNotification('Could not save quiz result.', true);
                }
            };

            const fetchAndDisplayQuizzes = async (userId) => {
                if (unsubscribeQuizzes) unsubscribeQuizzes();
                const { collection, query, orderBy, onSnapshot } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const q = query(collection(db, 'artifacts', appId, 'users', userId, 'savedQuizzes'), orderBy('createdAt', 'desc'));
                unsubscribeQuizzes = onSnapshot(q, (snapshot) => {
                    DOMElements.quizzesList.innerHTML = snapshot.empty 
                        ? `<p class="text-slate-500">You haven't saved any quizzes yet.</p>` 
                        : snapshot.docs.map(doc => {
                            const { createdAt, params } = doc.data();
                            const date = createdAt?.toDate().toLocaleDateString() || 'Recently';
                            const subject = params.gs_subject || params.csat_subject || 'Mixed';
                            const title = `${subject.charAt(0).toUpperCase() + subject.slice(1)} Quiz`;
                            
                            return `<div data-quiz-id="${doc.id}" class="p-4 border rounded-lg bg-slate-50 flex justify-between items-center">
                                        <div>
                                            <p class="font-semibold text-slate-800">${title}</p>
                                            <p class="text-sm text-slate-500">Taken on: ${date}</p>
                                        </div>
                                        <button data-action="delete-quiz" class="text-red-400 hover:text-red-600 transition-colors">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>`;
                        }).join('');
                }, (error) => {
                    console.error("Error fetching quizzes:", error);
                    DOMElements.quizzesList.innerHTML = `<p class="text-red-500">Could not fetch quizzes.</p>`;
                });
            };

            const deleteQuiz = async (quizId) => {
                if (!currentUser) { return; }
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'savedQuizzes', quizId));
                    showNotification('Quiz deleted successfully.');
                } catch (error) {
                    console.error("Error deleting quiz:", error);
                    showNotification('Could not delete quiz.', true);
                }
            };

            // --- Event Listeners ---
            document.body.addEventListener('click', async (e) => {
                const target = e.target;
                const targetId = target.id;
                
                if (['login-btn', 'mobile-login-btn', 'start-trial-btn', 'final-cta-btn'].includes(targetId)) { e.preventDefault(); openAuthModal('login'); }
                if (targetId === 'close-auth-modal') closeModal(DOMElements.authModal.modal);
                if (targetId === 'auth-switch-to-signup') openAuthModal('signup');
                if (targetId === 'auth-switch-to-login' || targetId === 'auth-switch-to-login-from-reset') openAuthModal('login');
                if (targetId === 'forgot-password-btn') {
                    document.getElementById('login-view').classList.add('hidden');
                    DOMElements.authModal.forgotPasswordView.classList.remove('hidden');
                }

                if (target.closest('#logout-btn, #mobile-logout-btn')) {
                    try { await firebaseAuth.signOut(auth); showNotification('Logged out.'); }
                    catch (error) { showNotification('Logout failed.', true); }
                }
                
                if (target.closest('[data-action="save-quiz"]')) {
                    saveQuizResult(target.closest('[data-action="save-quiz"]'));
                }

                if (target.closest('[data-action="delete-quiz"]')) {
                    const quizId = target.closest('[data-quiz-id]').dataset.quizId;
                    deleteQuiz(quizId);
                }
                
                if (target.closest('#current-affairs-card')) {
                    showNotification("We're currently working on this.");
                }

                if (target.closest('#planner-feature-card')) { 
                    DOMElements.plannerModal.questionnaire.reset();
                    DOMElements.plannerModal.questionnaire.classList.remove('hidden');
                    DOMElements.plannerModal.planResult.classList.add('hidden');
                    DOMElements.plannerModal.planResult.innerHTML = '';
                    DOMElements.plannerModal.questionnaire.querySelectorAll('[data-step]').forEach((step, index) => {
                        step.classList.toggle('active', index === 0);
                    });
                    openModal(DOMElements.plannerModal.modal); 
                }
                if (targetId === 'close-planner-modal') closeModal(DOMElements.plannerModal.modal);

                if (target.closest('#quizzie-feature-card')) { 
                    resetQuizzieModal(); 
                    openModal(DOMElements.quizzieModal.modal); 
                }
                if (targetId === 'close-quizzie-modal') closeModal(DOMElements.quizzieModal.modal);
                if(target.closest('[data-action="retake-quiz"]')) {
                    resetQuizzieModal();
                }
                
                const stepBtn = target.closest('.next-step-btn, .prev-step-btn');
                if (stepBtn) {
                    const modalForm = stepBtn.closest('form');
                    const currentStep = stepBtn.closest('[data-step]');
                    const currentStepNumber = parseInt(currentStep.dataset.step);
                    
                    let nextStepNumber = stepBtn.classList.contains('next-step-btn') 
                        ? currentStepNumber + 1 
                        : currentStepNumber - 1;

                    // Skip step 3 if test type is FLT
                    if (stepBtn.classList.contains('next-step-btn') && currentStepNumber === 2) {
                        const testType = new FormData(modalForm).get('test_type');
                        if (testType === 'flt') {
                            nextStepNumber = 4; // Skip to difficulty
                        }
                    }
                    if (stepBtn.classList.contains('prev-step-btn') && currentStepNumber === 4) {
                         const testType = new FormData(modalForm).get('test_type');
                        if (testType === 'flt') {
                            nextStepNumber = 2; // Skip back to test type
                        }
                    }

                    const nextStep = modalForm.querySelector(`[data-step="${nextStepNumber}"]`);
                    if (nextStep) { 
                        currentStep.classList.remove('active'); 
                        nextStep.classList.add('active'); 
                        updateQuizProgressBar(nextStepNumber, 4);
                    }
                }
            });

            DOMElements.authModal.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.elements['login-email'].value;
                const password = e.target.elements['login-password'].value;
                const errorEl = DOMElements.authModal.error;
                try {
                    await firebaseAuth.signInWithEmailAndPassword(auth, email, password);
                    closeModal(DOMElements.authModal.modal);
                } catch (error) {
                    console.error("Login failed:", error); // Log the actual error for debugging
                    errorEl.textContent = "Invalid email or password. Please check again.";
                    errorEl.classList.remove('hidden');
                }
            });

            DOMElements.authModal.signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.elements['signup-email'].value;
                const password = e.target.elements['signup-password'].value;
                const errorEl = DOMElements.authModal.error;
                try {
                    await firebaseAuth.createUserWithEmailAndPassword(auth, email, password);
                    closeModal(DOMElements.authModal.modal);
                    showNotification('Account created successfully!');
                } catch (error) { errorEl.textContent = error.message; errorEl.classList.remove('hidden'); }
            });

            DOMElements.authModal.forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.elements['reset-email'].value;
                const errorEl = DOMElements.authModal.error;
                try {
                    await firebaseAuth.sendPasswordResetEmail(auth, email);
                    showNotification('Password reset email sent. Please check your inbox.');
                    openAuthModal('login');
                } catch (error) {
                    console.error("Password Reset failed:", error);
                    errorEl.textContent = error.message;
                    errorEl.classList.remove('hidden');
                }
            });
            
            DOMElements.plannerModal.questionnaire.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const answers = Object.fromEntries(formData.entries());
                
                const { planResult, questionnaire } = DOMElements.plannerModal;
                
                questionnaire.classList.add('hidden');
                planResult.classList.remove('hidden');
                planResult.innerHTML = `<div class="p-4 bg-blue-50 rounded-lg text-center"><div class="font-semibold flex items-center justify-center"><span>Generating Your AI-Powered Plan</span><span class="pulsing-dots ml-1"><span>.</span><span>.</span><span>.</span></span></div></div>`;

                const aiPlanHTML = await generateAIStudyPlan(answers);

                generatedPlanHTML = `<h3 class="text-2xl font-bold mb-4 text-slate-800">Your Personalised 7-Day Plan</h3><p class="mb-4 text-slate-600"><strong>Level:</strong> ${answers.level.charAt(0).toUpperCase() + answers.level.slice(1)} | <strong>Commitment:</strong> ${answers.commitment.replace('-', ' ')} | <strong>Optional:</strong> ${answers.optional}</p><div class="overflow-x-auto">${aiPlanHTML}</div>`;
                
                planResult.innerHTML = `${generatedPlanHTML}<div class="mt-8 flex flex-col sm:flex-row gap-4"><button data-action="save-plan" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold flex-1">Save Plan to My Dashboard</button><button data-action="modify-plan" class="bg-slate-200 text-slate-800 px-6 py-3 rounded-lg font-semibold flex-1">Start Over</button></div>`;
            });


            DOMElements.plannerModal.planResult.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                if (action === 'save-plan') savePlan();
                if (action === 'modify-plan') { 
                    DOMElements.plannerModal.questionnaire.reset();
                    DOMElements.plannerModal.questionnaire.classList.remove('hidden');
                    DOMElements.plannerModal.planResult.classList.add('hidden');
                    DOMElements.plannerModal.planResult.innerHTML = '';
                     DOMElements.plannerModal.questionnaire.querySelectorAll('[data-step]').forEach((step, index) => {
                        step.classList.toggle('active', index === 0);
                    });
                }
            });

            DOMElements.quizzieModal.form.addEventListener('change', updateQuizzieForm);
            DOMElements.quizzieModal.form.addEventListener('submit', handleQuizSubmit);
            
            DOMElements.mobileMenuButton.addEventListener('click', () => DOMElements.mobileMenu.classList.toggle('hidden'));
            window.addEventListener('scroll', () => DOMElements.header.classList.toggle('shadow-md', window.scrollY > 50));
            const observer = new IntersectionObserver((entries) => entries.forEach(e => e.isIntersecting && e.target.classList.add('visible')), { threshold: 0.1 });
            document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
        });
    </script>
</body>
</html>

